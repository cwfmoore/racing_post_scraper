# End of Day Report Prompt

Generate a **post-racing data validation report** to verify results and BSP data have been captured.

## ‚ö†Ô∏è Output Format Requirements

**Format: Markdown (.md)**
- Output the report in proper GitHub-flavored markdown
- Use headers, tables, code blocks, and lists for structure
- ‚ö†Ô∏è **DO NOT** start with `---` (YAML front matter) - start directly with the `#` header

**Style: ADHD-Friendly**
- üéØ Use emojis liberally for visual markers and quick scanning
- üìä Use tables instead of paragraphs for data
- ‚úÖ‚ùå‚ö†Ô∏è Use status emojis prominently (checkmarks, X marks, warnings)
- üî¢ Keep bullet points short (1-2 lines max)
- üé® Use **bold** and `code` formatting to break up text
- üö´ Avoid walls of text - if it's more than 3 sentences, break it up

## When to Run

Run this report **after 6am AND after racing has finished** (recommended: 10pm UK time).

‚ö†Ô∏è **CRITICAL:** The daily scrape runs at **6am UTC**. Running this report before 6am will show missing data that hasn't been collected yet.

### üìÖ Data Collection Timeline
| When | What's Collected | Checked In This Report |
|------|------------------|------------------------|
| 6am TODAY | Today's racecard + stats | ‚úÖ Today's racecard |
| 6am TODAY | Yesterday's results + BSP | ‚úÖ Yesterday's results |
| 6am TOMORROW | Today's results + BSP | ‚ùå Not yet available |

### üïô What This Report Validates (at 10pm)
- **Today's racecard** ‚Üí Was collected at 6am this morning
- **Yesterday's results** ‚Üí Were collected at 6am this morning
- **Today's results** ‚Üí NOT available yet (collected tomorrow at 6am)

### ‚úÖ This Report Validates:
- **Today's racecard** was collected (‚ö†Ô∏è time-sensitive - can't backfill!)
- **Yesterday's results** are complete with BSP
- Run data matches expected runners
- No data quality issues

### ‚ö†Ô∏è Important: Time-Sensitive Data
Racecard data (C/D/G stats, jockey/trainer P/L) **cannot be backfilled**.
If today's racecard wasn't collected, that data is **lost forever**.

## Your Tools

Use the `claude_tools.py` module:

```python
from claude_tools import ClaudeTools
ct = ClaudeTools()
```

## Required Checks (in order)

### 1. Quick Validation (Start Here)
```python
ct.get_eod_validation()  # Quick pass/fail: today's racecard + yesterday's results
```
This returns a simple pass/fail status. If issues found, use functions below to investigate.

### 2. Full Summary (If Needed)
```python
ct.get_report_summary()  # All-in-one comprehensive report
```
This returns everything. Use individual functions below for drilling into issues.

### 3. Today's Racecard (‚ö†Ô∏è TIME-SENSITIVE)
```python
ct.get_races_by_date(ct.today())      # Today's races
ct.get_stats_coverage(days=1)          # Racecard/stats for today
```
Check:
- Racecard entries exist for today
- Horse race stats (C/D/G) captured
- Jockey/trainer stats captured

**üö® If missing:** Cannot backfill - flag as CRITICAL

### 4. Date Coverage
```python
ct.get_date_coverage(days=7)     # Recent date coverage
ct.get_date_range()               # Overall data range
```
Report: Coverage by date, days with missing data

### 5. Yesterday's Results
```python
ct.get_races_by_date(ct.yesterday())  # All yesterday's races
ct.find_missing_runs()                 # Races without run data
ct.find_incomplete_races()             # Runner count mismatches
```
Report: Races, run completeness, missing races

### 6. BSP Coverage
```python
ct.get_bsp_coverage(days=7)  # Betfair BSP data coverage
```
Report: BSP coverage %, missing BSP data

### 7. Data Quality
```python
ct.check_data_quality()  # Comprehensive quality checks
```
Report: Orphans, null values, mismatches

### 8. Historical Comparison
```python
ct.get_data_summary()  # Table row counts
ct.get_course_summary()  # Data by course
```
Report: Total records, growth over time

## Output Format

**Output as Markdown (.md)** - the report will be saved as a .md file.

Use this exact structure:

```
## Racing Post End of Day Report - {date}
Generated: {timestamp}

### üéØ Overall Status: {‚úÖ PASS / ‚ö†Ô∏è ISSUES FOUND}

### Issues Found
{Bulleted list of problems, or "‚úÖ None - all checks passed"}

---

### üìä 1. Data Summary
| Table | Records |
|-------|---------|
| rp_race | X |
| rp_run | X |
| rp_racecard_entry | X |
| rp_horse_race_stats | X |
| rp_betfair_price | X |

---

### üé´ 2. Today's Racecard ({today's date}) - ‚ö†Ô∏è TIME-SENSITIVE

| Metric | Value | Status |
|--------|-------|--------|
| Races Scheduled | X | - |
| Racecard Entries | X | ‚úÖ/‚ùå |
| Horse Race Stats | X | ‚úÖ/‚ùå |
| Jockey Stats | X | ‚úÖ/‚ùå |
| Trainer Stats | X | ‚úÖ/‚ùå |

**üö® If any are 0:** Data collection failed this morning - CANNOT backfill!

---

### üìÖ 3. Date Coverage (Last 7 Days)
| Date | Races | With Runs | Without Runs | Racecard | Stats |
|------|-------|-----------|--------------|----------|-------|
| ... | X | X | X | X | X |

**Dates Missing Data:** {list or "None"}

---

### üèá 4. Yesterday's Results ({yesterday's date})
| Metric | Value |
|--------|-------|
| Total Races | X |
| With Run Data | X |
| Coverage | X% |
| Incomplete Races | X |

**Races Without Results:**
| Course | Race | Expected Runners |
|--------|------|------------------|
| ... | ... | X |

---

### üí∞ 5. BSP Coverage (Last 7 Days)

‚ö†Ô∏è **IMPORTANT:** Always show daily breakdown - overall % can hide collection failures.

| Date | Runs | With BSP | Coverage | Status |
|------|------|----------|----------|--------|
| 2026-01-16 | X | X | X% | ‚úÖ/‚ùå |
| 2026-01-15 | X | X | X% | ‚úÖ/‚ùå |
| ... | ... | ... | ... | ... |

**Overall BSP Coverage:** X%

**üö® Collection Status Check:**
- If any recent day shows **0% BSP** ‚Üí Flag as "BSP COLLECTION STOPPED"
- If coverage drops from 100% to 0% on a specific date ‚Üí Identify when it stopped
- This usually indicates a **settings or scheduler issue**, not a data problem

---

### ‚ö†Ô∏è 6. Data Quality
| Check | Count | Status |
|-------|-------|--------|
| Orphaned Runs | X | ‚úÖ/‚ö†Ô∏è |
| Null Positions | X | ‚úÖ/‚ö†Ô∏è |
| Null SP | X | ‚úÖ/‚ö†Ô∏è |
| Null Jockey | X | ‚úÖ/‚ö†Ô∏è |
| Null Trainer | X | ‚úÖ/‚ö†Ô∏è |
| Runner Mismatches | X | ‚úÖ/‚ö†Ô∏è |

---

### üìà 7. Course Summary (Top 10)
| Course | Races | Runs | First Race | Last Race |
|--------|-------|------|------------|-----------|
| ... | X | X | YYYY-MM-DD | YYYY-MM-DD |

---

### üìä 8. Historical Stats
| Metric | Value |
|--------|-------|
| Earliest Date | YYYY-MM-DD |
| Latest Date | YYYY-MM-DD |
| Total Days | X |
| Total Races | X |
| Total Runs | X |

---

### üìù Summary
{2-3 sentence summary of data quality}

### üîî Action Items
{List any follow-up needed, or "None required"}
```

## Pass/Fail Criteria

| Check | ‚úÖ PASS | ‚ö†Ô∏è WARNING | ‚ùå FAIL |
|-------|---------|------------|---------|
| **Today's Racecard** | Entries > 0 | - | **0 entries (CRITICAL)** |
| **Today's Stats** | Stats > 0 | - | **0 stats (CRITICAL)** |
| Yesterday's Coverage | 100% with runs | 95-99% | <95% |
| BSP Coverage (daily) | ‚â•90% each day | 80-90% | <80% |
| BSP Collection | All days have data | - | **Any day at 0%** |
| Incomplete Races | 0 | 1-3 | >3 |
| Orphaned Runs | 0 | 1-10 | >10 |
| Null Positions | <1% | 1-5% | >5% |
| Data Staleness | ‚â§1 day behind | 2 days | >2 days |

## Alert Conditions

Flag these issues prominently:

| Condition | Level | Message |
|-----------|-------|---------|
| `today_racecard == 0` | ‚ùå CRITICAL | Today's racecard missing - DATA LOST FOREVER |
| `today_stats == 0` | ‚ùå CRITICAL | Today's stats missing - DATA LOST FOREVER |
| `days_behind > 2` | ‚ùå CRITICAL | Data collection falling behind |
| `any_day_bsp == 0%` | ‚ùå CRITICAL | BSP collection stopped - check settings/scheduler |
| `yesterday_coverage < 95%` | ‚ö†Ô∏è WARNING | Missing race results |
| `bsp_coverage < 80%` | ‚ö†Ô∏è WARNING | Low BSP coverage |
| `orphaned_runs > 10` | ‚ö†Ô∏è WARNING | Data integrity issues |
| `incomplete_races > 3` | ‚ö†Ô∏è WARNING | Runner count mismatches |
| `null_positions > 5%` | ‚ö†Ô∏è WARNING | Missing result data |

## Rules

1. **Run get_report_summary() first** - it has everything
2. **Check TODAY's racecard FIRST** - time-sensitive, cannot backfill!
3. **Check YESTERDAY's results** - collected this morning, should be complete
4. **Flag missing racecard as CRITICAL** - data is lost forever
5. **Flag missing results as WARNING** - can be re-scraped
6. **Include specific details** - race IDs, course names for follow-up
7. **Compare to baseline** - today vs average matters

## Quick Commands

For quick pass/fail validation (recommended first step):
```python
ct.get_eod_validation()  # Quick check: today's racecard + yesterday's results
```

For full end-of-day validation:
```python
ct.get_report_summary()  # Returns everything in one call
```

For checking today's racecard (‚ö†Ô∏è TIME-SENSITIVE):
```python
ct.get_races_by_date(ct.today())       # Today's races
ct.get_stats_coverage(days=1)           # Racecard/stats coverage
```

For checking yesterday's results:
```python
ct.get_races_by_date(ct.yesterday())   # Yesterday's races
ct.find_missing_runs()                  # Races without run data
ct.find_incomplete_races()              # Runner count mismatches
ct.get_bsp_coverage(days=7)             # BSP coverage
ct.get_race_details(race_id)            # Specific race deep dive
```

For historical comparison:
```python
ct.get_date_coverage(days=14)  # Two weeks coverage
ct.get_course_summary()        # By course
ct.get_data_summary()          # All tables
```

## Available Functions Reference

### Summary Reports
| Function | Purpose |
|----------|---------|
| `ct.get_eod_validation()` | **Quick pass/fail check** (start here!) |
| `ct.get_report_summary()` | **All-in-one EOD report** |
| `ct.get_data_summary()` | Table row counts |
| `ct.get_date_range()` | Overall data range |

### Coverage Analysis
| Function | Purpose |
|----------|---------|
| `ct.get_date_coverage(days)` | Coverage by date |
| `ct.get_stats_coverage(days)` | Racecard/stats coverage |
| `ct.get_bsp_coverage(days)` | BSP data coverage |
| `ct.get_races_by_date(date)` | All races for a date |

### Data Quality
| Function | Purpose |
|----------|---------|
| `ct.check_data_quality()` | Comprehensive quality checks |
| `ct.find_missing_runs()` | Races without run data |
| `ct.find_incomplete_races()` | Runner count mismatches |

### Lookups
| Function | Purpose |
|----------|---------|
| `ct.get_race_details(race_id)` | Full race with runners |
| `ct.get_horse_history(horse_id)` | Horse race history |
| `ct.get_course_summary()` | Data by course |
| `ct.search_horse(name)` | Find horse by name |

### Duplicate Detection
| Function | Purpose |
|----------|---------|
| `ct.find_duplicate_trainers()` | Duplicate trainer records |
| `ct.find_duplicate_jockeys()` | Duplicate jockey records |
| `ct.find_duplicate_owners()` | Duplicate owner records |
| `ct.find_all_duplicates()` | All duplicates summary |

### Date Helpers
| Function | Purpose |
|----------|---------|
| `ct.today()` | Today's date string |
| `ct.yesterday()` | Yesterday's date string |

### Custom SQL
| Function | Purpose |
|----------|---------|
| `ct.run_sql(query, params)` | Custom queries |
| `ct.execute_sql(query, params)` | Write operations |
| `ct.get_tables()` | List all rp_* tables |

## Troubleshooting Common Issues

### Missing Race Results
```python
missing = ct.find_missing_runs()
for m in missing:
    print(f"{m['date']} - {m['course']} - {m['race_name']} (race_id: {m['race_id']})")
```

### Incomplete Races
```python
incomplete = ct.find_incomplete_races()
for r in incomplete:
    print(f"{r['course']}: expected {r['expected']}, got {r['actual']} (race_id: {r['race_id']})")
```

### Low BSP Coverage
```python
bsp = ct.get_bsp_coverage(days=7)
for d in bsp['by_date']:
    if d['pct'] < 80:
        print(f"{d['date']}: only {d['pct']}% BSP coverage")
```

### Data Quality Issues
```python
quality = ct.check_data_quality()
for issue in quality['issues']:
    print(f"‚ö†Ô∏è {issue}")
```
