"""Generate BSP backfill SQL for Jan 27 2026."""

import json
import os
from rapidfuzz import fuzz

temp_dir = os.environ.get('TEMP', '/tmp')

# Load BSP data
with open(f'{temp_dir}/bsp_lookup.json', 'r') as f:
    bsp_data = json.load(f)

print(f"Loaded {len(bsp_data)} BSP records")

# All 186 runs from the database query
runs = [{"run_id": "4833", "horse_name": "aristelle", "race_date": "2026-01-27", "off_time": "12:45"}, {"run_id": "4831", "horse_name": "autumn getaway", "race_date": "2026-01-27", "off_time": "12:45"}, {"run_id": "4830", "horse_name": "dancing diana", "race_date": "2026-01-27", "off_time": "12:45"}, {"run_id": "4829", "horse_name": "i c u in my dreams", "race_date": "2026-01-27", "off_time": "12:45"}, {"run_id": "4832", "horse_name": "nowherenearmilan", "race_date": "2026-01-27", "off_time": "12:45"}, {"run_id": "4826", "horse_name": "orestina", "race_date": "2026-01-27", "off_time": "12:45"}, {"run_id": "4827", "horse_name": "pure ocean", "race_date": "2026-01-27", "off_time": "12:45"}, {"run_id": "4828", "horse_name": "luna grace", "race_date": "2026-01-27", "off_time": "12:45"}, {"run_id": "4775", "horse_name": "monsieur jaco", "race_date": "2026-01-27", "off_time": "13:00"}, {"run_id": "4779", "horse_name": "good for you", "race_date": "2026-01-27", "off_time": "13:00"}, {"run_id": "4771", "horse_name": "highbury hill", "race_date": "2026-01-27", "off_time": "13:00"}, {"run_id": "4778", "horse_name": "boston joe", "race_date": "2026-01-27", "off_time": "13:00"}, {"run_id": "4777", "horse_name": "dessie haze", "race_date": "2026-01-27", "off_time": "13:00"}, {"run_id": "4773", "horse_name": "dont tell rosie", "race_date": "2026-01-27", "off_time": "13:00"}, {"run_id": "4780", "horse_name": "locked down lad", "race_date": "2026-01-27", "off_time": "13:00"}, {"run_id": "4776", "horse_name": "crossbeau", "race_date": "2026-01-27", "off_time": "13:00"}, {"run_id": "4772", "horse_name": "out of focus", "race_date": "2026-01-27", "off_time": "13:00"}, {"run_id": "4774", "horse_name": "rest is the best", "race_date": "2026-01-27", "off_time": "13:00"}, {"run_id": "4791", "horse_name": "buddah castle", "race_date": "2026-01-27", "off_time": "13:20"}, {"run_id": "4789", "horse_name": "eagles reprieve", "race_date": "2026-01-27", "off_time": "13:20"}, {"run_id": "4788", "horse_name": "le beau madrik", "race_date": "2026-01-27", "off_time": "13:20"}, {"run_id": "4790", "horse_name": "loulou madrik", "race_date": "2026-01-27", "off_time": "13:20"}, {"run_id": "4792", "horse_name": "return to florida", "race_date": "2026-01-27", "off_time": "13:20"}, {"run_id": "4795", "horse_name": "sparky tom", "race_date": "2026-01-27", "off_time": "13:20"}, {"run_id": "4793", "horse_name": "the final brig", "race_date": "2026-01-27", "off_time": "13:20"}, {"run_id": "4794", "horse_name": "moonlight trail", "race_date": "2026-01-27", "off_time": "13:20"}, {"run_id": "4743", "horse_name": "berkshire smudge", "race_date": "2026-01-27", "off_time": "13:30"}, {"run_id": "4742", "horse_name": "brave guest", "race_date": "2026-01-27", "off_time": "13:30"}, {"run_id": "4744", "horse_name": "jedhi knight", "race_date": "2026-01-27", "off_time": "13:30"}, {"run_id": "4741", "horse_name": "misterdoc", "race_date": "2026-01-27", "off_time": "13:30"}, {"run_id": "4740", "horse_name": "only one blue", "race_date": "2026-01-27", "off_time": "13:30"}, {"run_id": "4739", "horse_name": "senator", "race_date": "2026-01-27", "off_time": "13:30"}, {"run_id": "4738", "horse_name": "thewoodcorner", "race_date": "2026-01-27", "off_time": "13:30"}, {"run_id": "4798", "horse_name": "pony soprano", "race_date": "2026-01-27", "off_time": "13:50"}, {"run_id": "4797", "horse_name": "spadestep", "race_date": "2026-01-27", "off_time": "13:50"}, {"run_id": "4796", "horse_name": "the grafter", "race_date": "2026-01-27", "off_time": "13:50"}, {"run_id": "4799", "horse_name": "kids say lastgojoe", "race_date": "2026-01-27", "off_time": "13:50"}, {"run_id": "4718", "horse_name": "west to the bridge", "race_date": "2026-01-27", "off_time": "14:02"}, {"run_id": "4725", "horse_name": "pyramid place", "race_date": "2026-01-27", "off_time": "14:02"}, {"run_id": "4720", "horse_name": "french emperor", "race_date": "2026-01-27", "off_time": "14:02"}, {"run_id": "4724", "horse_name": "el capitaine", "race_date": "2026-01-27", "off_time": "14:02"}, {"run_id": "4721", "horse_name": "castelfort", "race_date": "2026-01-27", "off_time": "14:02"}, {"run_id": "4723", "horse_name": "high tea", "race_date": "2026-01-27", "off_time": "14:02"}, {"run_id": "4719", "horse_name": "grenadier jed", "race_date": "2026-01-27", "off_time": "14:02"}, {"run_id": "4727", "horse_name": "torrent", "race_date": "2026-01-27", "off_time": "14:02"}, {"run_id": "4726", "horse_name": "boyles hill", "race_date": "2026-01-27", "off_time": "14:02"}, {"run_id": "4722", "horse_name": "slim marvel", "race_date": "2026-01-27", "off_time": "14:02"}, {"run_id": "4812", "horse_name": "eire street", "race_date": "2026-01-27", "off_time": "14:25"}, {"run_id": "4807", "horse_name": "parish quiz", "race_date": "2026-01-27", "off_time": "14:25"}, {"run_id": "4815", "horse_name": "le beau gosse", "race_date": "2026-01-27", "off_time": "14:25"}, {"run_id": "4811", "horse_name": "half track", "race_date": "2026-01-27", "off_time": "14:25"}, {"run_id": "4808", "horse_name": "kalo athena", "race_date": "2026-01-27", "off_time": "14:25"}, {"run_id": "4813", "horse_name": "wainwright", "race_date": "2026-01-27", "off_time": "14:25"}, {"run_id": "4809", "horse_name": "blue indigo", "race_date": "2026-01-27", "off_time": "14:25"}, {"run_id": "4814", "horse_name": "annies gold", "race_date": "2026-01-27", "off_time": "14:25"}, {"run_id": "4810", "horse_name": "dartmhor", "race_date": "2026-01-27", "off_time": "14:25"}, {"run_id": "4714", "horse_name": "juby ball", "race_date": "2026-01-27", "off_time": "14:37"}, {"run_id": "4715", "horse_name": "palacio", "race_date": "2026-01-27", "off_time": "14:37"}, {"run_id": "4716", "horse_name": "dj pete", "race_date": "2026-01-27", "off_time": "14:37"}, {"run_id": "4717", "horse_name": "storming nelson", "race_date": "2026-01-27", "off_time": "14:37"}, {"run_id": "4713", "horse_name": "stencil", "race_date": "2026-01-27", "off_time": "14:37"}, {"run_id": "4801", "horse_name": "pitwood road", "race_date": "2026-01-27", "off_time": "15:00"}, {"run_id": "4805", "horse_name": "mary stanford", "race_date": "2026-01-27", "off_time": "15:00"}, {"run_id": "4804", "horse_name": "just call me lucy", "race_date": "2026-01-27", "off_time": "15:00"}, {"run_id": "4800", "horse_name": "twistthenightaway", "race_date": "2026-01-27", "off_time": "15:00"}, {"run_id": "4806", "horse_name": "roses dart", "race_date": "2026-01-27", "off_time": "15:00"}, {"run_id": "4802", "horse_name": "our laura b", "race_date": "2026-01-27", "off_time": "15:00"}, {"run_id": "4803", "horse_name": "its maisy", "race_date": "2026-01-27", "off_time": "15:00"}, {"run_id": "4728", "horse_name": "charisma cat", "race_date": "2026-01-27", "off_time": "15:12"}, {"run_id": "4730", "horse_name": "clondaw park", "race_date": "2026-01-27", "off_time": "15:12"}, {"run_id": "4735", "horse_name": "cue jump", "race_date": "2026-01-27", "off_time": "15:12"}, {"run_id": "4734", "horse_name": "daring to dream", "race_date": "2026-01-27", "off_time": "15:12"}, {"run_id": "4736", "horse_name": "dont cheddar tear", "race_date": "2026-01-27", "off_time": "15:12"}, {"run_id": "4737", "horse_name": "issadora", "race_date": "2026-01-27", "off_time": "15:12"}, {"run_id": "4733", "horse_name": "karlita desbois", "race_date": "2026-01-27", "off_time": "15:12"}, {"run_id": "4731", "horse_name": "man maid", "race_date": "2026-01-27", "off_time": "15:12"}, {"run_id": "4729", "horse_name": "trinity street", "race_date": "2026-01-27", "off_time": "15:12"}, {"run_id": "4732", "horse_name": "milady du breuil", "race_date": "2026-01-27", "off_time": "15:12"}, {"run_id": "4782", "horse_name": "young jack", "race_date": "2026-01-27", "off_time": "15:35"}, {"run_id": "4787", "horse_name": "marown", "race_date": "2026-01-27", "off_time": "15:35"}, {"run_id": "4781", "horse_name": "theformismighty", "race_date": "2026-01-27", "off_time": "15:35"}, {"run_id": "4783", "horse_name": "if not for dylan", "race_date": "2026-01-27", "off_time": "15:35"}, {"run_id": "4784", "horse_name": "fenland tiger", "race_date": "2026-01-27", "off_time": "15:35"}, {"run_id": "4786", "horse_name": "shighness", "race_date": "2026-01-27", "off_time": "15:35"}, {"run_id": "4785", "horse_name": "the big breac", "race_date": "2026-01-27", "off_time": "15:35"}, {"run_id": "4754", "horse_name": "supervisor", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4747", "horse_name": "bells of peterboro", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4746", "horse_name": "genietoile", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4755", "horse_name": "bali body", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4756", "horse_name": "phantom getaway", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4748", "horse_name": "the jam man", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4749", "horse_name": "ali star bert", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4758", "horse_name": "star of diamonds", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4760", "horse_name": "the grey man", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4751", "horse_name": "bolsover bill", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4750", "horse_name": "the magus", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4759", "horse_name": "the moonlight man", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4745", "horse_name": "fat faced columbo", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4753", "horse_name": "roi lion", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4757", "horse_name": "john w creasy", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4752", "horse_name": "the big reveal", "race_date": "2026-01-27", "off_time": "15:47"}, {"run_id": "4823", "horse_name": "quickasican", "race_date": "2026-01-27", "off_time": "16:10"}, {"run_id": "4817", "horse_name": "burning it up", "race_date": "2026-01-27", "off_time": "16:10"}, {"run_id": "4819", "horse_name": "snow dragon", "race_date": "2026-01-27", "off_time": "16:10"}, {"run_id": "4824", "horse_name": "rightbackatyou", "race_date": "2026-01-27", "off_time": "16:10"}, {"run_id": "4825", "horse_name": "diamond trilogy", "race_date": "2026-01-27", "off_time": "16:10"}, {"run_id": "4820", "horse_name": "kingofthegame", "race_date": "2026-01-27", "off_time": "16:10"}, {"run_id": "4822", "horse_name": "steel soldier", "race_date": "2026-01-27", "off_time": "16:10"}, {"run_id": "4821", "horse_name": "breadalbane lass", "race_date": "2026-01-27", "off_time": "16:10"}, {"run_id": "4818", "horse_name": "rock n roll champ", "race_date": "2026-01-27", "off_time": "16:10"}, {"run_id": "4816", "horse_name": "parish star", "race_date": "2026-01-27", "off_time": "16:10"}, {"run_id": "4769", "horse_name": "barrow hill lad", "race_date": "2026-01-27", "off_time": "16:22"}, {"run_id": "4762", "horse_name": "big john ollie", "race_date": "2026-01-27", "off_time": "16:22"}, {"run_id": "4763", "horse_name": "justalargewhisky", "race_date": "2026-01-27", "off_time": "16:22"}, {"run_id": "4761", "horse_name": "keltype", "race_date": "2026-01-27", "off_time": "16:22"}, {"run_id": "4764", "horse_name": "mr winter", "race_date": "2026-01-27", "off_time": "16:22"}, {"run_id": "4766", "horse_name": "nez vert", "race_date": "2026-01-27", "off_time": "16:22"}, {"run_id": "4765", "horse_name": "thepassingcyclone", "race_date": "2026-01-27", "off_time": "16:22"}, {"run_id": "4768", "horse_name": "the quant", "race_date": "2026-01-27", "off_time": "16:22"}, {"run_id": "4767", "horse_name": "westbrooke boy", "race_date": "2026-01-27", "off_time": "16:22"}, {"run_id": "4770", "horse_name": "jubilee jack", "race_date": "2026-01-27", "off_time": "16:22"}, {"run_id": "4838", "horse_name": "hows the guvnor", "race_date": "2026-01-27", "off_time": "16:28"}, {"run_id": "4845", "horse_name": "bungle bay", "race_date": "2026-01-27", "off_time": "16:28"}, {"run_id": "4846", "horse_name": "mythical isle", "race_date": "2026-01-27", "off_time": "16:28"}, {"run_id": "4840", "horse_name": "homme de fer", "race_date": "2026-01-27", "off_time": "16:28"}, {"run_id": "4839", "horse_name": "fistral beach", "race_date": "2026-01-27", "off_time": "16:28"}, {"run_id": "4844", "horse_name": "buttercross flyer", "race_date": "2026-01-27", "off_time": "16:28"}, {"run_id": "4841", "horse_name": "tootsie", "race_date": "2026-01-27", "off_time": "16:28"}, {"run_id": "4842", "horse_name": "eye of the water", "race_date": "2026-01-27", "off_time": "16:28"}, {"run_id": "4843", "horse_name": "musaytir", "race_date": "2026-01-27", "off_time": "16:28"}, {"run_id": "4886", "horse_name": "river wharfe", "race_date": "2026-01-27", "off_time": "17:00"}, {"run_id": "4885", "horse_name": "court of session", "race_date": "2026-01-27", "off_time": "17:00"}, {"run_id": "4887", "horse_name": "bad habits", "race_date": "2026-01-27", "off_time": "17:00"}, {"run_id": "4889", "horse_name": "bandello", "race_date": "2026-01-27", "off_time": "17:00"}, {"run_id": "4891", "horse_name": "paps of jura", "race_date": "2026-01-27", "off_time": "17:00"}, {"run_id": "4890", "horse_name": "rogue thunder", "race_date": "2026-01-27", "off_time": "17:00"}, {"run_id": "4888", "horse_name": "oldbury lad", "race_date": "2026-01-27", "off_time": "17:00"}, {"run_id": "4834", "horse_name": "horwich", "race_date": "2026-01-27", "off_time": "17:30"}, {"run_id": "4836", "horse_name": "big moonrise", "race_date": "2026-01-27", "off_time": "17:30"}, {"run_id": "4835", "horse_name": "kokushoku", "race_date": "2026-01-27", "off_time": "17:30"}, {"run_id": "4837", "horse_name": "lucky sevens", "race_date": "2026-01-27", "off_time": "17:30"}, {"run_id": "4868", "horse_name": "midnight call", "race_date": "2026-01-27", "off_time": "18:00"}, {"run_id": "4872", "horse_name": "causin a commotion", "race_date": "2026-01-27", "off_time": "18:00"}, {"run_id": "4871", "horse_name": "juno star", "race_date": "2026-01-27", "off_time": "18:00"}, {"run_id": "4874", "horse_name": "la lunita", "race_date": "2026-01-27", "off_time": "18:00"}, {"run_id": "4873", "horse_name": "my turn now", "race_date": "2026-01-27", "off_time": "18:00"}, {"run_id": "4875", "horse_name": "stoneacre girl", "race_date": "2026-01-27", "off_time": "18:00"}, {"run_id": "4869", "horse_name": "sultan of oj", "race_date": "2026-01-27", "off_time": "18:00"}, {"run_id": "4870", "horse_name": "the defiant", "race_date": "2026-01-27", "off_time": "18:00"}, {"run_id": "4855", "horse_name": "prince quattro", "race_date": "2026-01-27", "off_time": "18:30"}, {"run_id": "4856", "horse_name": "chicago storm", "race_date": "2026-01-27", "off_time": "18:30"}, {"run_id": "4858", "horse_name": "daaris", "race_date": "2026-01-27", "off_time": "18:30"}, {"run_id": "4859", "horse_name": "eagle one", "race_date": "2026-01-27", "off_time": "18:30"}, {"run_id": "4857", "horse_name": "slowdownbarney", "race_date": "2026-01-27", "off_time": "18:30"}, {"run_id": "4854", "horse_name": "billy bathgate", "race_date": "2026-01-27", "off_time": "18:30"}, {"run_id": "4853", "horse_name": "himself", "race_date": "2026-01-27", "off_time": "18:30"}, {"run_id": "4878", "horse_name": "warrior queen", "race_date": "2026-01-27", "off_time": "19:00"}, {"run_id": "4877", "horse_name": "he bangs the drums", "race_date": "2026-01-27", "off_time": "19:00"}, {"run_id": "4881", "horse_name": "curated", "race_date": "2026-01-27", "off_time": "19:00"}, {"run_id": "4882", "horse_name": "lady birgma", "race_date": "2026-01-27", "off_time": "19:00"}, {"run_id": "4883", "horse_name": "forceful lady", "race_date": "2026-01-27", "off_time": "19:00"}, {"run_id": "4876", "horse_name": "luna beaux", "race_date": "2026-01-27", "off_time": "19:00"}, {"run_id": "4879", "horse_name": "oh so perfect", "race_date": "2026-01-27", "off_time": "19:00"}, {"run_id": "4884", "horse_name": "calabrian soldato", "race_date": "2026-01-27", "off_time": "19:00"}, {"run_id": "4880", "horse_name": "mon petit frere", "race_date": "2026-01-27", "off_time": "19:00"}, {"run_id": "4848", "horse_name": "rajinoora", "race_date": "2026-01-27", "off_time": "19:30"}, {"run_id": "4847", "horse_name": "rose cotton", "race_date": "2026-01-27", "off_time": "19:30"}, {"run_id": "4852", "horse_name": "ghaiyyath park", "race_date": "2026-01-27", "off_time": "19:30"}, {"run_id": "4851", "horse_name": "abila", "race_date": "2026-01-27", "off_time": "19:30"}, {"run_id": "4850", "horse_name": "pink socks", "race_date": "2026-01-27", "off_time": "19:30"}, {"run_id": "4849", "horse_name": "leeson street", "race_date": "2026-01-27", "off_time": "19:30"}, {"run_id": "4864", "horse_name": "son of astar", "race_date": "2026-01-27", "off_time": "20:00"}, {"run_id": "4866", "horse_name": "alafdhal", "race_date": "2026-01-27", "off_time": "20:00"}, {"run_id": "4865", "horse_name": "thank the lord", "race_date": "2026-01-27", "off_time": "20:00"}, {"run_id": "4862", "horse_name": "spendmore lane", "race_date": "2026-01-27", "off_time": "20:00"}, {"run_id": "4860", "horse_name": "rogue de vega", "race_date": "2026-01-27", "off_time": "20:00"}, {"run_id": "4867", "horse_name": "nordic games", "race_date": "2026-01-27", "off_time": "20:00"}, {"run_id": "4863", "horse_name": "some nightmare", "race_date": "2026-01-27", "off_time": "20:00"}, {"run_id": "4861", "horse_name": "phils dream", "race_date": "2026-01-27", "off_time": "20:00"}, {"run_id": "4893", "horse_name": "street life", "race_date": "2026-01-27", "off_time": "20:30"}, {"run_id": "4897", "horse_name": "mini magna", "race_date": "2026-01-27", "off_time": "20:30"}, {"run_id": "4894", "horse_name": "amerjeet", "race_date": "2026-01-27", "off_time": "20:30"}, {"run_id": "4896", "horse_name": "buraback", "race_date": "2026-01-27", "off_time": "20:30"}, {"run_id": "4892", "horse_name": "shalaa asker", "race_date": "2026-01-27", "off_time": "20:30"}, {"run_id": "4898", "horse_name": "forest gunner", "race_date": "2026-01-27", "off_time": "20:30"}, {"run_id": "4895", "horse_name": "sir benedict", "race_date": "2026-01-27", "off_time": "20:30"}]

# Match
matched = 0
unmatched = []
values = []

for run in runs:
    run_date = run['race_date']
    run_time = run['off_time']
    horse = run['horse_name'].strip()

    best_match = None
    best_score = 0

    for bsp in bsp_data:
        if bsp['date'] == run_date and bsp['time'] == run_time:
            score = fuzz.ratio(horse, bsp['horse'])
            if score > best_score:
                best_score = score
                best_match = bsp

    if best_match and best_score >= 77:
        values.append(f"({run['run_id']}, {best_match['bsp']}, {best_match['wap']}, {best_match['morning_wap']}, {best_match['pre_min']}, {best_match['pre_max']}, {best_match['ip_min']}, {best_match['ip_max']}, {best_match['morning_vol']}, {best_match['pre_vol']}, {best_match['ip_vol']}, NOW(), NOW())")
        matched += 1
    else:
        unmatched.append(f"{horse} @ {run_time}")

print(f"Matched: {matched}/{len(runs)}")
print(f"Unmatched: {len(unmatched)}")

# Output SQL file
sql = f"""-- Backfill BSP data for Jan 27 2026
-- Generated by backfill script
-- Matched {matched}/{len(runs)} runners

INSERT INTO rp_betfair_price (run_id, bsp, wap, morning_wap, pre_min, pre_max, ip_min, ip_max, morning_vol, pre_vol, ip_vol, created_at, updated_at)
VALUES
""" + ",\n".join(values) + ";"

with open(f'{temp_dir}/bsp_backfill.sql', 'w') as f:
    f.write(sql)

print(f"\nSQL saved to {temp_dir}/bsp_backfill.sql")
if unmatched:
    print(f"\nUnmatched horses:")
    for u in unmatched:
        print(f"  - {u}")
